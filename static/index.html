<!DOCTYPE html>
<html lang="es" class="dark">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>PAN GPT</title>
        <script>
            tailwind = { config: { darkMode: 'class' } };
        </script>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
        <!-- Markdown parser -->
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    </head>
    <body class="h-screen bg-zinc-900 text-zinc-100">
        <div id="app" class="h-full flex">
            <!-- Sidebar -->
            <aside
                class="hidden md:flex w-64 flex-col border-r border-zinc-800 bg-zinc-950"
            >
                <div class="p-4 border-b border-zinc-800">
                    <button
                        @click="newChat"
                        class="w-full inline-flex items-center justify-center gap-2 rounded-md bg-zinc-800 hover:bg-zinc-700 px-3 py-2 text-sm font-medium"
                    >
                        <span class="text-lg">Ôºã</span>
                        Nueva conversaci√≥n
                    </button>
                </div>
                <div class="p-4 text-zinc-400 text-sm">Historial (PoC)</div>
            </aside>

            <!-- Main -->
            <main class="flex-1 flex flex-col">
                <!-- Header -->
                <header
                    class="sticky top-0 z-10 border-b border-zinc-800 bg-zinc-900/80 backdrop-blur"
                >
                    <div
                        class="max-w-3xl mx-auto px-4 h-14 flex items-center justify-between"
                    >
                        <div class="flex items-center gap-2">
                            <div
                                class="h-7 w-7 rounded bg-zinc-800 grid place-items-center"
                                >ü§ñ</div
                            >
                            <div class="font-semibold">Pan GPT</div>
                        </div>
                        <a
                            href="/health"
                            class="text-xs text-zinc-400 hover:text-zinc-200"
                            >health</a
                        >
                    </div>
                </header>

                <!-- Messages -->
                <section ref="messageScroll" class="flex-1 overflow-y-auto">
                    <div class="max-w-3xl mx-auto px-4 py-6 space-y-4">
                        <div
                            v-if="messages.length === 0"
                            class="text-center text-zinc-400 py-20"
                        >
                            Empieza una conversaci√≥n con Pan GPT
                        </div>

                        <template v-for="(m, i) in messages" :key="i">
                            <div
                                class="flex gap-3"
                                :class="m.role === 'assistant' ? 'justify-start' : 'justify-end'"
                            >
                                <div
                                    v-if="m.role === 'assistant'"
                                    class="h-8 w-8 rounded bg-emerald-600 grid place-items-center shrink-0"
                                    >ü§ñ</div
                                >
                                <div
                                    class="max-w-[85%] rounded-lg px-4 py-3 leading-relaxed prose prose-invert"
                                    :class="m.role === 'assistant' ? 'bg-zinc-800' : 'bg-emerald-600 text-white'"
                                    v-html="md(m.content)"
                                ></div>
                                <div
                                    v-if="m.role === 'user'"
                                    class="h-8 w-8 rounded bg-zinc-700 grid place-items-center shrink-0"
                                    >üßë‚Äçüíª</div
                                >
                            </div>
                        </template>

                        <div
                            v-if="loading"
                            class="flex items-center gap-2 text-zinc-400"
                        >
                            <div
                                class="h-8 w-8 rounded bg-emerald-600 grid place-items-center"
                                >ü§ñ</div
                            >
                            <div class="flex gap-1 items-center">
                                <span
                                    class="w-2 h-2 bg-zinc-400/70 rounded-full animate-bounce [animation-delay:-0.2s]"
                                ></span>
                                <span
                                    class="w-2 h-2 bg-zinc-400/70 rounded-full animate-bounce"
                                ></span>
                                <span
                                    class="w-2 h-2 bg-zinc-400/70 rounded-full animate-bounce [animation-delay:0.2s]"
                                ></span>
                            </div>
                        </div>

                        <div v-if="error" class="text-red-400 text-sm"
                            >{{ error }}</div
                        >
                    </div>
                </section>

                <!-- Input -->
                <footer class="border-t border-zinc-800 bg-zinc-900">
                    <div class="max-w-3xl mx-auto px-4 py-4">
                        <div
                            class="rounded-xl border border-zinc-700 bg-zinc-800 focus-within:ring-1 focus-within:ring-emerald-500"
                        >
                            <textarea
                                v-model="question"
                                @keydown.enter.exact.prevent="send"
                                @keydown.enter.shift.exact.stop
                                rows="1"
                                placeholder="Escribe tu mensaje..."
                                class="w-full resize-none bg-transparent outline-none px-4 py-3 text-zinc-100 placeholder:text-zinc-500"
                            ></textarea>
                            <div
                                class="flex items-center justify-between px-2 pb-2"
                            >
                                <div class="text-xs text-zinc-500 px-2"
                                    >Enter para enviar ‚Ä¢ Shift+Enter para saltos
                                    de l√≠nea</div
                                >
                                <button
                                    @click="send"
                                    :disabled="loading || !question.trim()"
                                    class="inline-flex items-center gap-2 rounded-md bg-emerald-600 hover:bg-emerald-500 disabled:bg-emerald-800 px-3 py-2 text-sm font-medium"
                                >
                                    <span>Enviar</span>
                                    <svg
                                        xmlns="http://www.w3.org/2000/svg"
                                        viewBox="0 0 24 24"
                                        fill="currentColor"
                                        class="w-4 h-4"
                                    >
                                        <path
                                            d="M2.3 2.3a1 1 0 0 1 1.04-.24l18 6a1 1 0 0 1 0 1.88l-18 6A1 1 0 0 1 2 15V9l11 3-11-3V3a1 1 0 0 1 .3-.7z"
                                        />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </footer>
            </main>
        </div>

        <script>
            const { createApp, ref, onMounted, nextTick } = Vue;

            createApp({
                setup() {
                    const question = ref('');
                    const messages = ref([]);
                    const loading = ref(false);
                    const error = ref('');
                    const messageScroll = ref(null);

                    function scrollToBottom() {
                        nextTick(() => {
                            if (messageScroll.value) {
                                messageScroll.value.scrollTop =
                                    messageScroll.value.scrollHeight;
                            }
                        });
                    }

                    function newChat() {
                        messages.value = [];
                        question.value = '';
                        error.value = '';
                    }

                    async function send() {
                        const q = question.value.trim();
                        if (!q || loading.value) return;
                        error.value = '';
                        messages.value.push({ role: 'user', content: q });
                        question.value = '';
                        loading.value = true;
                        scrollToBottom();
                        try {
                            const res = await fetch('/query', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ question: q }),
                            });
                            if (!res.ok) {
                                const data = await res.json().catch(() => ({}));
                                throw new Error(
                                    data?.detail || `HTTP ${res.status}`
                                );
                            }
                            const data = await res.json();
                            messages.value.push({
                                role: 'assistant',
                                content: data.answer || '',
                            });
                        } catch (e) {
                            error.value = e.message || String(e);
                        } finally {
                            loading.value = false;
                            scrollToBottom();
                        }
                    }

                    onMounted(scrollToBottom);

                    function md(text) {
                        if (window.marked) {
                            return marked.parse(text || '');
                        }
                        return text;
                    }

                    return {
                        question,
                        messages,
                        loading,
                        error,
                        send,
                        newChat,
                        messageScroll,
                        md,
                    };
                },
            }).mount('#app');
        </script>
    </body>
</html>
